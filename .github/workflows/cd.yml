name: CD - Deploy to DigitalOcean

#on:
#  push:
#    branches: ["main"]
#  workflow_dispatch:
on:
  workflow_run:
    workflows: ["collection_api_ci"]
    types: [completed]


concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (optional)
        uses: actions/checkout@v4

      - name: Deploy via SSH (git pull + docker compose up)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail

            echo "== Go to project directory =="
            cd "${{ secrets.PROJECT_PATH }}"

            echo "== Git sync (hard reset to origin/main) =="
            git fetch --all --prune
            git reset --hard origin/main

            echo "== Current commit on server =="
            git rev-parse --short HEAD

            echo "== Sanity checks =="
            test -f docker-compose.yml || test -f compose.yml
            test -f .env || (echo "❌ .env not found in PROJECT_PATH" && exit 1)
            test -f Caddyfile || (echo "❌ Caddyfile not found in PROJECT_PATH" && exit 1)

            echo "== Rebuild backend without cache (force changes) =="
            docker compose build --no-cache backend

            echo "== Start/Update services =="
            docker compose up -d --remove-orphans

            echo "== Show running containers =="
            docker compose ps

            echo "== Done ✅ =="
